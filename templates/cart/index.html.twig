{% extends 'base.html.twig' %}

{% block title %}Cart{% endblock %}

{% block body %}
 <div class="container mx-auto px-4 mt-8">
        {% for item in cart %}
            <div class="w-full max-w-4xl mx-auto mb-4">
                <div class="bg-white shadow-sm border-0 rounded-lg">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="text-lg font-bold mb-0">{{ item.name }}</h5>
                            <span
                                class="text-green-600 font-bold text-xl item-total-price">{{ item.price * item.quantity }}€</span>
                        </div>
                        <p class="text-gray-600 mb-3">
                            <span class="text-gray-500">Price per item:</span>
                            <span class="text-green-600 font-bold item-price">{{ item.price }}€</span>
                        </p>
                        <div class="flex justify-between items-center">
                            <div class="flex" role="group" aria-label="Quantity controls">
                                <input type="hidden" class="product" value="{{ item.id }}" />
                                <a href="#" class="px-3 py-1 border border-gray-300 text-gray-700 text-sm rounded-l-md hover:bg-gray-50 remove-quantity inline-block text-center min-w-[2rem]">-</a>
                                <span class="px-3 py-1 bg-gray-100 border-t border-b border-gray-300 text-sm quantity inline-block text-center min-w-[2rem]">{{ item.quantity }}</span>
                                <a href="#" class="px-3 py-1 border border-gray-300 text-gray-700 text-sm rounded-r-md hover:bg-gray-50 add-quantity inline-block text-center min-w-[2rem]">+</a>
                            </div>
                            <form method="POST" action="{{ path('app_cart_remove', {productId: item.id}) }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('cart.remove') }}">
                                <button type="submit" class="px-3 py-1 border border-red-300 text-red-700 text-sm rounded-md hover:bg-red-50 bg-white">Remove item</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="w-full max-w-2xl mx-auto text-center">
                <strong class="text-gray-500">The cart is empty</strong>
            </div>
        {% endfor %}

        {% if cart and cart|length > 0 %}
            <div class="w-full max-w-2xl mx-auto text-right mt-4 flex justify-between items-center">
                <p class="text-right font-bold">Total price: {{ totalPrice }} €</p>
                <div class="flex">
                  <button class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 mx-1 !important" style="background-color: #dc2626 !important;">Remove cart</button>
                </div>
            </div>
            <div class="w-full max-w-4xl mx-auto text-right mt-4">
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="p-6">
                        <form method="POST" action="{{ path('app_order') }}">
                            <input type="hidden" name="_token" value="{{ csrf_token('order.store') }}">
                            <div class="mb-4">
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
                                <input type="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent{% if app.session.flashbag.has('error.email') %} border-red-500{% endif %}"
                                    id="email" name="email" aria-describedby="emailHelp">
                                <div id="emailHelp" class="text-sm text-gray-500 mt-1">We'll never share your email with anyone else.</div>
                                {% for message in app.session.flashbag.get('error.email') %}
                                    <div class="text-red-600 text-sm mt-1">{{ message }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-4">
                                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Full name</label>
                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent{% if app.session.flashbag.has('error.fullname') %} border-red-500{% endif %}"
                                    name="fullname" id="fullName">
                                {% for message in app.session.flashbag.get('error.fullname') %}
                                    <div class="text-red-600 text-sm mt-1">{{ message }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-4">
                                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent{% if app.session.flashbag.has('error.address') %} border-red-500{% endif %}"
                                    name="address" id="address">
                                {% for message in app.session.flashbag.get('error.address') %}
                                    <div class="text-red-600 text-sm mt-1">{{ message }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-4">
                                <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent{% if app.session.flashbag.has('error.city') %} border-red-500{% endif %}"
                                    name="city" id="city">
                                {% for message in app.session.flashbag.get('error.city') %}
                                    <div class="text-red-600 text-sm mt-1">{{ message }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-4">
                                <label for="postCode" class="block text-sm font-medium text-gray-700 mb-1">Post code</label>
                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent{% if app.session.flashbag.has('error.postcode') %} border-red-500{% endif %}"
                                    name="postcode" id="postCode">
                                {% for message in app.session.flashbag.get('error.postcode') %}
                                    <div class="text-red-600 text-sm mt-1">{{ message }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-4 flex items-center">
                                <input type="checkbox" name="terms" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded{% if app.session.flashbag.has('error.terms') %} border-red-500{% endif %}" id="exampleCheck1">
                                <label class="ml-2 block text-sm text-gray-700" for="exampleCheck1">Accept service and terms </label>
                                {% for message in app.session.flashbag.get('error.terms') %}
                                    <div class="text-red-600 text-sm mt-1">{{ message }}</div>
                                {% endfor %}
                            </div>
                            <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 mr-2 !important" style="background-color: #16a34a !important;">Pay</button>
                        </form>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    <script>
        $(document).ready(function() {
            $('.add-quantity').on('click', function(e) {
                e.preventDefault(); // Prevent default action of the button
                let product = $(this).closest('.card').find('.product').val();
                let vm = $(this);
                console.log(product);
                $.ajax({
                    type: 'POST',
                    url: `cart/add/quantity/${product}`,
                    datatype: 'JSON',
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr(
                            'content') // Add CSRF token for security
                    },
                    success: function(result) {
                        let cartCount = result.items;
                        let totalPrice = result.totalPrice;
                        let quantity = result.quantity;
                        let itemTotalPrice = result.itemTotalPrice;
                        vm.closest('.card').find('.item-total-price').text(itemTotalPrice +
                            "€");
                        vm.prev().text(quantity);
                        $('.total-price').text(totalPrice + "€");
                        $('.cart-count').text(cartCount);
                    }
                });
            });
            $('.remove-quantity').on('click', function(e) {
                let product = $(this).prev().val();
                let quantity = $(this).next().text();
                let vm = $(this);
                if (quantity <= 1) {
                    return;
                }
                $.ajax({
                    type: 'POST',
                    url: `cart/remove/quantity/${product}`,
                    datatype: 'JSON',
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr(
                            'content') // Add CSRF token for security
                    },
                    success: function(result) {
                        let cartCount = result.items;
                        let totalPrice = result.totalPrice;
                        quantity = result.quantity;
                        let itemTotalPrice = result.itemTotalPrice;
                        console.log(itemTotalPrice);
                        vm.closest('.card').find('.item-total-price').text(itemTotalPrice +
                            "€");
                        vm.next().text(quantity);
                        $('.total-price').text(totalPrice + "€");
                        $('.cart-count').text(cartCount);
                    }
                });
            });
        });
    </script>
{% endblock %}
